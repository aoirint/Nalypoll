{% extends 'base_fluid.html' %}

{% block pagetitle %}{{ tweet.author.name }} (@{{ tweet.author.screen_name }}) さんの投票ツイート: {{ tweet.text_oneline |truncatechars:40}} - TwiLivePolls{% endblock %}

{% block main %}
<div class="pt-4"></div>

<div id="data_polls"
  data-tweet="{{ tweet.json }}"
  data-polls="{{ tweet.polls_json }}"
></div>

<div class="row mx-lg-5">
  <div id="embed_tweet_container" class="d-flex justify-content-center align-items-center col-12 col-lg-4"></div>

  <div id="chart_polls" class="my-5 py-5 col-12 col-lg-8"></div>
</div>

<script>
(function() {
  function timestampSeconds2label(timestampSeconds) {
    let de = new Date(timestampSeconds * 1000);
    let h = new String(de.getHours());
    if (h.length == 1) h = '0' + h;

    let m = new String(de.getMinutes());
    if (m.length == 1) m = '0' + m;

    return h + ':' + m;
  }

  let dataPollsElm = document.querySelector('#data_polls');
  let tweet = JSON.parse(dataPollsElm.dataset.tweet);
  let polls = JSON.parse(dataPollsElm.dataset.polls);

  let embedTweetContainer = document.querySelector('#embed_tweet_container');
  twttr.ready(twttr => {
    twttr.widgets.createTweet(tweet.id, embedTweetContainer, {
    }).then(elm => {
    });
  });

  let chartPollsElm = document.querySelector('#chart_polls');

  for (let poll of polls) {
    let chartPollElm = document.createElement('canvas');
    chartPollElm.width = 1600;
    chartPollElm.height = 900;
    chartPollsElm.appendChild(chartPollElm);

    let chartPollCtx = chartPollElm.getContext('2d');

    let options = Object.keys(poll.votes);
    let timestamps = poll.timestamps;
    let datasets = [];
    let backgroundColors = [
      'rgba(255, 99, 132, 0.2)',
      'rgba(54, 162, 235, 0.2)',
      'rgba(255, 206, 86, 0.2)',
      'rgba(75, 192, 192, 0.2)',
    ];
    let borderColors = [
      'rgba(255, 99, 132, 1)',
      'rgba(54, 162, 235, 1)',
      'rgba(255, 206, 86, 1)',
      'rgba(75, 192, 192, 1)',
    ];

    let sampleCount = poll.votes[options[0]].length;
    for (let optionIndex in options) {
      let option = options[optionIndex];
      let votesList = poll.votes[option];
      let data = [];

      data.push({
        'x': tweet.posted_at,
        'y': 0,
      });

      for (let votesIndex in votesList) {
        data.push({
          'x': timestamps[votesIndex],
          'y': votesList[votesIndex],
        })
      }

      datasets.push({
        'label': option,
        'data': data,
        'backgroundColor': backgroundColors[optionIndex],
        'borderColor': borderColors[optionIndex],
        'borderWidth': 1,
      })
    }

    let chartPoll = new Chart(chartPollCtx, {
      'type': 'line',
      'data': {
        'datasets': datasets,
      },
      'options': {
        'scales': {
          'xAxes': [{
            'type': 'linear',
            'position': 'bottom',
            'ticks': {
              'autoSkip': true,
              'maxRotation': 90,
              'minRotation': 90,
              'min': tweet.posted_at,
              // 'max': poll.endtime,
              'callback': (value, index, values) => {
                return timestampSeconds2label(value);
              },
            },
          }],
        },
        'tooltips': {
          'mode': 'index',
          'intersect': false,
          'itemSort': (a, b, data) => b.yLabel - a.yLabel,
          'callbacks': {
            'title': (tooltipItems, data) => {
              let timestamp = parseInt(tooltipItems[0].xLabel); // original label
              let title = timestampSeconds2label(timestamp);

              return title;
            },
          },
        },
        'hover': {
          'mode': 'index',
          'intersect': false,
        }
      },
    });

    break;
  }

})();
</script>

{% endblock %}
